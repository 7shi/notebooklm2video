# プロンプト

想定した形式で出力を得るため、プロンプトに出力例を添えます。

Gemini 1.5 Flash 002 では時間が文字起こしの時間がずれたりなどの不具合があるため、Gemini 1.5 Flash Experimental 0827 を推奨します。

作業用ディレクトリを作成して、NotebookLM からダウンロードした音声ファイルを src.wav にリネームして配置します。

# 文字起こし

Google AI Studio では添付ファイルは Google Drive にアップロードされます。容量を節約するため MP3 に変換すると良いでしょう。

```sh
ffmpeg -i src.wav -vn -ac 1 -ar 44100 -ab 128k -acodec libmp3lame -f mp3 src.mp3
```

音声ファイルを添付して、文字起こしを指示します。

```text:プロンプト
Please transcribe this conversation, in the table format of timecode, speaker, caption. Use speaker A, speaker B, etc. to identify speakers.

|timecode|speaker|caption|
|---|---|---|
|00:00|A|text|
```

## 翻訳

ハルシネーションを防ぐため、冗長ですが対訳形式を採用します。多過ぎると途中で止まるため、全体を適当に分割します。

```text:プロンプト
xx:xxからyy:yyまで日本語に翻訳してください。英語で難解な表現に語釈を付け、背景説明は不要です。

|時間|話者|英語|日本語訳|注釈|
|---|---|---|---|----|
|00:00|A|text|テキスト|word: 単語。|
```

# 仕切り直し

全文を保持したままではトークン消費が激しいため、新しいチャットで仕切り直します。英語のログを貼って、まずは内容を評価させます。思ったような結果が得られないときは Gemini 1.5 Pro に切り替えると良いでしょう。

```text:プロンプト
これは『〇〇』について話す台本です。
```

## テーマ

```text:プロンプト
話されているテーマを、タイムライン順にリストアップしてください。
```

### 整理

```text:プロンプト
表形式で整理してください。

|No|時間|テーマ|
|---:|----|----|
|1|00:00|(text)|
```

### 統合

分割が細かすぎる場合、調整を指示します。

```text:プロンプト
テーマが多すぎます。2～4個ずつ統合して、30個程度に絞り込んでください。
```

### 関連付け

確実に関連付けるため、テーマごとに最初の発言をピックアップします。

```text:プロンプト
テーマごとに最初の発言を英語でピックアップしてください（引用符は不要）。結果は表形式で出力してください。

|No|時間|テーマ|最初の発言|
|----|----|----|----|
|1|00:00|(text)|(text)|
```

### 画像

画像を生成するための指示文を生成します。Stable Diffusion XL などを使用する場合は、プロンプト形式を指定すれば良いでしょう。

```text:プロンプト
テーマごとに挿絵を考えてください。挿絵はプロンプト形式ではなく、英語で文章化してください。結果は表形式で出力してください。

|No|時間|テーマ|挿絵|
|----|----|----|----|
|1|00:00.00|(text)|...|
```

## タイトル画像

指示の例を示します。これは特に決められた形式である必要はないため、具体的なアイデアがあれば、それに基づいて指示を書いてください。

```text:プロンプト
全体の流れを考慮して、タイトル画像の案を5つ考えてください。プロンプト形式や箇条書きではなく、50語程度の英語の文章として指示を書いてください。
```

# ログの変換

Google AI Studio のログを変換するためのコードを提供します。変換方法は 2 通りあるため、どちらか一方を選んでください。

1. ログを Google Drive から取得して変換
   ```sh
   python json2md.py log.json
   ```
2. Get code から `history=[...]` をコピー  
   Python のソースファイルに貼り付けます。そのファイルの先頭で変換に必要な関数をインポートして使用します。添付ファイルがある場合はダミーで `files` を定義します。
   ```python:log1.py
   from json2md import print_convert
   files = [0]
   print_convert(history=[
     ...
     ]
   )
   ```
   ```python:log2.py
   from json2md import print_convert
   print_convert(history=[
     ...
     ]
   )
   ```

## データの抽出

変換したログから、以下の各テーブルからヘッダを取り除いたデータを抽出します。

1. table0.txt: 文字起こし
   ```sh
   python extract-table.py log1.md "| timecode | speaker | caption |" > table0.txt
   ```
2. table1.txt: 翻訳
   ```sh
   python extract-table.py log1.md "| 時間 | 話者 | 英語 | 日本語訳 | 注釈 |" > table1.txt
   ```
3. table2.txt: 関連付け
   ```sh
   python extract-table.py log2.md "| No | Time | Theme | First Utterance |" > table2.txt
   ```

※ テーブルヘッダは変化することがあるため、ログに合わせます。

## 過不足の確認

翻訳の際に過不足が発生することがあるため、確認します。

```sh
python check-table.py table0.txt table1.txt
diff -u table0_.txt table1_.txt
```

差分が発生すれば、手動で調整します。

## 最初と最後の項目を追加

table1.txt を手動で編集して、最初（タイトル）と最後（音声の長さ）の項目を追加します。

```text:最初
| 00:00 | | Author<br>Title | 作者<br>タイトル | Conversation: NotebookLM<br>Director: Gemini 1.5 Flash<br>Image: Stable Diffusion 3 |
```
```text:最後
| 音声の長さ |
```

# 画像生成

table2.txt から画像を生成します。生成する手段は何でも構いません。ローカルで高速に生成できない場合、オンラインサービスが利用できます。個人的に使っているサービスを以下に示します。

* [リートン](https://wrtn.jp/): Stable Diffusion 3
* [Poe](https://poe.com/): Playground v3

生成した画像は src ディレクトリに保存します。タイトル画像を 001.png として、それ以降の画像は連番で保存します。連番を付けるのが面倒な場合、スクリプトで保存順にリネームします。

```python
python rename.py src
```

## リサイズ

画像は 800x600 にリサイズします。スクリプトでは、アスペクト比を維持して横幅を 800 にリサイズしてから、縦幅を 600 にトリミングします。出力先のディレクトリは dst1 を指定します。

```sh
python resize.py -o dst1 src
```

# 作業用ファイルの生成

作業に必要なファイル一式を生成します。

```sh
python generate.py
```

※ どのような作業を行うかは、生成された Makefile を確認してください。

## 字幕の合成

画像に字幕を合成するための image.html を開きます。文字がはみ出す箇所は、table1.txt を編集して調整します。編集後に generate.py で再生成して、ブラウザはリロードします。

※ 話者の欄は生成には影響しないため、間違っていても放置して構いません。

## キャプチャ

字幕の調整が完了すれば、画像をキャプチャします。image.html をリロードして最初のページを開きます。

capture.png を開き、座標を調整します。

```py:変更箇所
mx, my = 526, 864           # [▶] ボタンをクリックする座標
rect = (80, 226, 800, 600)  # 画像の領域
```

スクリプトを実行すれば、ページを自動的にめくって画像をキャプチャします。

```sh
python capture.py
```

キャプチャした画像は dst2 ディレクトリに保存されます。

## 動画の生成

FFmpeg を使用して、画像と音声から動画を生成します。

スクリプトによって生成された Makefile で作業を行います。

```sh
make
```

正常に動画が生成されれば、dst4.mp4 が作成されます。

## タイミングの調整

文字起こしは秒単位で行われるため、字幕のタイミングがずれることがあります。table1.txt を編集してタイミングを調整します。`02:31.5` のように小数点以下の秒が指定できます。

タイミングの調整後、作業用ファイルを作成して、再生成を行います。

```sh
make clean
python generate.py
make
```

※ `make clean` の代わりに、dst3 内で影響を受けるファイルを手動で削除すれば、作業時間が短縮できます。
